package database;

import queue.metasploitConsumer;

import java.sql.*;
import java.text.SimpleDateFormat;
import java.util.Date;

public class ExploitRecord extends AbstractRecord {
    ExploitRecord(Connection connection) throws SQLException {
        super(connection);
    }

    @Override
    public void addRecord(String IP,String result,String module,String taskname,String taskdate,String desc,String object) {
        String table="ExploitResult1";
        synchronized (connection){
            String sql="SELECT table_name FROM information_schema.TABLES WHERE table_name='"+table+"';";
            try{
                Statement statement=this.connection.createStatement();
                ResultSet set=statement.executeQuery(sql);
                if(!set.next()){
                    this.connection.createStatement().executeUpdate("CREATE TABLE if NOT EXISTS "+table+" (IP text," +
                            "exploitobject text," +
                            "exploitresult TEXT," +
                            "taskname TEXT," +
                            "taskdate TEXT," +
                            "taskdesc TEXT," +
                            "Insert_date DATE ," +
                            "exploitmodule varchar(100));");
                }
                sql="SELECT * FROM "+table+" WHERE IP='"+IP+"' and exploitmodule='"+module+"' and exploitresult='"+result+"'"+
                        "and taskname='"+taskname+"'"+"and taskdate='"+taskdate+"'";
                ResultSet resultSet=connection.createStatement().executeQuery(sql);
                if(!resultSet.next()){
                    PreparedStatement ptmt=connection.prepareStatement("INSERT INTO "+table+"(IP,exploitobject,exploitresult,taskname,taskdate,taskdesc,exploitmodule,Insert_date) values (?,?,?,?,?,?,?,?)");
                    ptmt.setString(1,IP);
                    ptmt.setString(2,object);;
                    ptmt.setString(3,result);
                    ptmt.setString(4,taskname);
                    ptmt.setString(5,taskdate);
                    ptmt.setString(6,desc);
                    ptmt.setString(7,module);
                    java.util.Date d=new Date();
                    SimpleDateFormat sdf = new SimpleDateFormat("yyyy-MM-dd");
                    String idate = sdf.format(d);
                    ptmt.setString(8,idate);
                    ptmt.executeUpdate();
                    ptmt.close();
                }
            }catch (Exception e){
                e.printStackTrace();
            }
        }
        System.out.println("Record Success");
    }


}
