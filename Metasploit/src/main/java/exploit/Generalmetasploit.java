package exploit;

import org.json.JSONObject;

import java.io.*;
import java.util.ArrayList;
import java.util.List;

public class Generalmetasploit {
    public List<String> excuteExploit(String ip,String protocol){
//        String output_file="/home/iot/Project/Metasploit/exploit/"+protocol;
//        String scriptPath="/home/iot/Project/Metasploit/Script/GeneralExploit.py";
        String output_file="/ScanScript/MetasploitResult/"+protocol;
        String scriptPath="/ScanScript/GeneralExploit.py";
        String passwordFile="/ScanScript/PassWord";
        String Result="";
        List<String> res=new ArrayList<>();
        System.out.println(protocol);
        try{
//            File dir=new File("/home/iot/Project/Metasploit/exploit");
            File dir=new File(output_file);
            if(!dir.exists())
                dir.mkdirs();
            File[] files=dir.listFiles();
            for(File file:files){
                file.delete();
            }
            String tempcmd="python3 "+scriptPath+" "+protocol+" "+ip+" "+output_file+" "+passwordFile;
            System.out.println(tempcmd);
            Process p=Runtime.getRuntime().exec(tempcmd);
            InputStream in = p.getInputStream();
            BufferedReader br = new BufferedReader(new InputStreamReader(in));
            String li = br.readLine();
            while(li!=null) {
                System.out.println(li);
                li = br.readLine();
            }
//            File dir2=new File("/home/iot/Project/Metasploit/exploit");
            File dir2=new File(output_file);
            for(File file:dir2.listFiles()){
                System.out.println(file.toString());
                InputStreamReader inputStreamReader=new InputStreamReader(new FileInputStream(file),"UTF-8");
                BufferedReader bufferedReader = new BufferedReader(inputStreamReader);
                String result="";
                String line="";
                while((line=bufferedReader.readLine())!=null){
                    result=result+line;
                }
                //logger.info(result);
                System.out.println(result);
                try{
                    JSONObject arr= (JSONObject) new JSONObject("{\"list\":"+result+"}").get("list");
                    String expoitResult=arr.getString("result");
                    String module=arr.getString("module");
                    Result="{\"result\":\""+expoitResult+"\","+"\"module\":\""+module+"\"}";
                    res.add(Result);
                }catch (Exception e){
                    e.printStackTrace();
                }

                //logger.info(expoitResult);
            }
        }catch (Exception e){
            e.printStackTrace();
        }
        return res;
    }
    public static void main(String[] args){
        Generalmetasploit test=new Generalmetasploit();
        test.excuteExploit("127.0.0.1","http");
    }
}
