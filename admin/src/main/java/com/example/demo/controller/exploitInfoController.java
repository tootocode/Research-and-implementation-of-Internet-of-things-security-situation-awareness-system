package com.example.demo.controller;

import com.example.demo.database.Query.deviceInfoQuery;
import com.example.demo.database.Query.exploitInfoQuery;
import com.example.demo.database.Record.DatabaseConfig;
import com.example.demo.database.Record.Record;
import com.example.demo.database.Record.RecordFactory;
import com.example.demo.database.Record.exploitRecord;
import com.example.demo.entity.deviceInfo;
import com.example.demo.entity.exploitInfo;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.CrossOrigin;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RestController;

import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.List;

@RestController
@CrossOrigin
public class exploitInfoController {

    @Autowired
    private DatabaseConfig databaseConfig;
    @GetMapping("/postexploitInfo")
    public String postdata(String name,String target,String bug,String desc){
        RecordFactory recordFactory=new RecordFactory(databaseConfig);
        Record record=recordFactory.get(exploitRecord.class);
        record.addRecord(name,target,bug,desc);
        return "success";
    }

    @GetMapping("/searchexploitInfo")
    public List<exploitInfo> getdata(String name, String target, String bug) throws SQLException {
        if(name.equals("")&&target.equals("")&&bug.equals(""))return new ArrayList<>();
        String sql="select * from exploittable where ";
        if(!name.equals(""))sql=sql+"model='"+name+"'";
        if(!name.equals("")&&!target.equals(""))sql=sql+" and target='"+target+"'";
        else if(name.equals("")&&!target.equals(""))sql=sql+"target='"+target+"'";
        if((!name.equals("")||!target.equals(""))&&!bug.equals(""))sql=sql+" and bug='"+bug+"'";
        else if(name.equals("")&&target.equals(""))sql=sql+" bug='"+bug+"'";
        String mysqlPath="jdbc:mysql://"+databaseConfig.getMysqlip()+"/DeviceMark?useSSL=false&serverTimezone=UTC&allowPublicKeyRetrieval=true";
        Connection connection= DriverManager.getConnection(mysqlPath,"root","123456");
        exploitInfoQuery exploitInfoQuery=new exploitInfoQuery(connection);
        System.out.println(sql);
        List<exploitInfo> result=exploitInfoQuery.queryRecord(sql);
        connection.close();
        return result;
    }

    @GetMapping("/getexploitinfolist")
    public List<exploitInfo> getInitdata() throws SQLException {
        List<exploitInfo> list=new ArrayList<>();
        String sql="select * from exploittable";
        String mysqlPath="jdbc:mysql://"+databaseConfig.getMysqlip()+"/DeviceMark?useSSL=false&serverTimezone=UTC&allowPublicKeyRetrieval=true";
        Connection connection= DriverManager.getConnection(mysqlPath,"root","123456");
        exploitInfoQuery exploitInfoQuery=new exploitInfoQuery(connection);
        System.out.println(sql);
        list=exploitInfoQuery.queryRecord(sql);
        connection.close();
        return list;
    }
}
